## 小程序走读
Marketing类，
init 初始化
update 组件显示
destrory 组件销毁
disabled 组件未销毁，隐藏

弹窗机制：
- 优先采集事件数据
- 弹窗信息回来前，先缓存事件信息
- 弹窗信息回来后，消费并清空
- 之后的事件信息直接与弹窗信息匹配
- 预览弹窗不进行信息匹配，直接弹窗

保证 in_app_message_imp  in_app_message_click  in_app_message_close 正常上报

## 什么时候带u
app启动时 获取本地bu --> 有则使用bu无则使用u --> 获取本地bcs  --> 有则使用bcs无则使用本地cs --> 本地没有cs的话则bcs，cs都不使用


### 核心实例
- 全局实例
  - gio
  - growingio
  - gioEmitter
  - growingio.marketingHos，lt 
  - getParametev是从是、 BVSB                                                                                                                                                                                                                                                                                                                                                        rByName()
- StatusStorage类
  - _get(messageId, cs1)是老数据的话则返回对应的value并从缓存里清除掉它们
  - _set(messageId, cs1, v)有messageId,cs1,value即可保存到缓存里
  - get(messageId, cs1) 从_get拿到value，本地没有缓存过的message给予默认showTimes，showDate.本地缓存过的message，json添加showTimes，showDate，最终返回value。核心就是返回一个有messageId，cs1,showTimes,showDate的value
  - plus(messageId, cs1, key, num) v[key]=v[key]+num , this._set(messageId, cs1, v)
- UserStorage类
  - namespace:[push-user-status],duration:50天
  - _get(key) key=messageId+cs1
  - set(key, value) 是新数据则value+ startAt.是旧数据的话value有变动时则更新startAt并覆盖，旧数据没变化的话则不动它。
  - get(key) 有效期内的弹窗value可以返回，过期的value不返还。有效期：最近一次value更新时间+50天
- Marketing类
  - console.log('Marketing 启动.');
  - statusStorage:[push-status]
  - userStorage:[push-user-status]
  - isPreview
  - isRequested
  - isDispatching 是否有派发中的事件
  - listener
  - fetchedMessages 请求回来的弹窗信息
  - renderQueue 等待渲染的弹窗队列，多事件同时触发时
  - unResolvedEvents 未处理的事件队列，用于处理弹窗信息未回来前的事件，使其不至于遗漏

  - handleCS1
  - handleClearCs1
  - handleEvent
  - addGlobalEventListener

  - init() addEventListener()
  - update() 实例显示时触发 refetchPushMessage() 
  - disabled() 实例隐藏时触发 resetState();setPreviewState();清空渲染事件队列，待消费事件队列与弹窗数据
  - destroy() disabled();isInit=false;removeEventListener
  - addEventListener() 监听appOpen，upload事件
  - removeEventListener() 关闭监听xx事件
  - gatherUnResolvedEvents()
  - clearUnResolvedEvents()
  - clearFetchedMessages()
  
  - formatUrl() 获取bu; bcs; u=growingio.info.uid, cs1=gio('getUserId')
    - projectId = growingio.vdsConfig.projectId;url_scheme=growingio.vdsConfig.appId
  
  - fetchPushMessage() 请求url，set bcs与bu，获取popupWindows时按updateAt排序，失败的话

  - fetchPreviewPushMessage(messageId) triggerListener(previewMessages[0])
  - refetchPushMessage() 重置isRequested参数，clearFetchedMessages()再fetchPushMessage(),最后定时下this.timer每30分钟请求一次

  - consumeUnResolvedEvents(event) 根据事件过滤fetchedMessages生成validMessages，默认只将第一个放入渲染队列里 renderQueue.push(validMessages[0])
  - 所谓消费事件就是将它放入等待队列里,因为是在fetchPushMessage成功时执行consumeUnResolvedEvents的。如果此时没有事件捕获的话，且有未处理的事件就消费未处理事件队列里的第一个事件

- consumeNextMessage isDispatching是false的话，执行dispatchMessage()
- dispatchMessage() isDispatching是false时，从渲染队列里捞出第一个message，triggerListener(message)
- getValidMessages(event,messages) validActionType，validTimeRange，validateTriggerCd，validateTimes

- onTrackImp(message) 上报弹窗事件后，增加showtimes，更新cd时间点
- onCloseWindow(message) 分发消息
- onClickTarget
- [修改版本platform.config.js里的sdkVer]